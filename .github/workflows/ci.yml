name: CI

# Run on push to main or branch, and PR to main
on:
  push:
    branches: [ main, Kash-updated-UI-Branch ]
  pull_request:
    branches: [ main ]

jobs:
   # Install backend deps
   backend:
     runs-on: ubuntu-latest
     defaults:
       run:
         working-directory: ./backend
     steps:
     - uses: actions/checkout@v3
     - name: Setup Node.js
       uses: actions/setup-node@v3
       with:
         node-version: '18'
         cache: 'npm'
         cache-dependency-path: backend/package-lock.json
     - run: npm install
     - name: Run tests
       run: npm test || echo "No tests defined"

   # Install and build customer app
   customer:
     runs-on: ubuntu-latest
     defaults:
       run:
         working-directory: ./customer
     steps:
     - uses: actions/checkout@v3
     - name: Setup Node.js
       uses: actions/setup-node@v3
       with:
         node-version: '18'
         cache: 'npm'
         cache-dependency-path: customer/package-lock.json
     - run: npm install
     - run: npm run build
     - name: Run tests
       run: npm test -- --coverage --watchAll=false

   # Install employee deps
   employee:
     runs-on: ubuntu-latest
     defaults:
       run:
         working-directory: ./employee
     steps:
     - uses: actions/checkout@v3
     - name: Setup Node.js
       uses: actions/setup-node@v3
       with:
         node-version: '18'
         cache: 'npm'
         cache-dependency-path: employee/package-lock.json
     - run: npm install
     - name: Run tests
       run: npm test -- --coverage --watchAll=false

  # Run SonarQube scan
  sonarqube:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    needs: [backend, customer, employee]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}